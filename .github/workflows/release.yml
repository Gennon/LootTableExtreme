# Auto-generated release workflow for LootTableExtreme
# Ensures GitHub Actions detects and lists this workflow
name: Create Release

on:
  workflow_dispatch:
    inputs:
      increment:
        description: 'Version increment type'
        required: true
        default: 'patch'
        type: choice
        options:
          - major
          - minor
          - patch

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Extract version from TOC
        id: version
        run: |
          # Extract version from LootTableExtreme.toc
          TOC_VERSION=$(grep "^## Version:" LootTableExtreme.toc | sed 's/^## Version: //')
          echo "toc_version=$TOC_VERSION" >> $GITHUB_OUTPUT
          echo "Found TOC version: $TOC_VERSION"
          
          # Parse Major.Minor.Patch
          IFS='.' read -r MAJOR MINOR PATCH <<< "$TOC_VERSION"
          echo "major=$MAJOR" >> $GITHUB_OUTPUT
          echo "minor=$MINOR" >> $GITHUB_OUTPUT
          echo "patch=$PATCH" >> $GITHUB_OUTPUT
          
          # Increment version if requested
          if [ "${{ github.event.inputs.increment }}" = "major" ]; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
          elif [ "${{ github.event.inputs.increment }}" = "minor" ]; then
            MINOR=$((MINOR + 1))
            PATCH=0
          elif [ "${{ github.event.inputs.increment }}" = "patch" ]; then
            PATCH=$((PATCH + 1))
          fi
          
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"
      
      - name: Calculate build number
        id: build
        run: |
          # Count total number of commits as build number
          BUILD_NUMBER=$(git rev-list --count HEAD)
          echo "number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "Build number: $BUILD_NUMBER"
      
      - name: Update TOC version
        run: |
          sed -i "s/^## Version: .*/## Version: ${{ steps.version.outputs.new_version }}/" LootTableExtreme.toc
          sed -i "s/^## Version: .*/## Version: ${{ steps.version.outputs.new_version }}/" LootTableExtreme_TBC.toc || true
          # Update runtime version in Core.lua so addon shows the same version
          sed -i "s/^LootTableExtreme.version = \".*\"/LootTableExtreme.version = \"${{ steps.version.outputs.new_version }}\"/" Core.lua || true
          echo "Updated TOC files and Core.lua to version ${{ steps.version.outputs.new_version }}"
      
      - name: Create release packages
        id: package
        run: |
          VERSION="${{ steps.version.outputs.new_version }}.${{ steps.build.outputs.number }}"
          VANILLA_FILE="LootTableExtreme_${VERSION}_Vanilla.zip"
          TBC_FILE="LootTableExtreme_${VERSION}_TBC.zip"

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "vanilla_filename=$VANILLA_FILE" >> $GITHUB_OUTPUT
          echo "tbc_filename=$TBC_FILE" >> $GITHUB_OUTPUT

          # Prepare directories
          rm -rf package || true
          mkdir -p package/vanilla/LootTableExtreme
          mkdir -p package/tbc/LootTableExtreme

          # Copy all candidate addon files into both packages
          cp *.lua package/vanilla/LootTableExtreme/ || true
          cp *.xml package/vanilla/LootTableExtreme/ || true
          cp *.toc package/vanilla/LootTableExtreme/ || true

          cp *.lua package/tbc/LootTableExtreme/ || true
          cp *.xml package/tbc/LootTableExtreme/ || true
          cp *.toc package/tbc/LootTableExtreme/ || true

          # For Vanilla package: remove TBC-specific files
          rm -f package/vanilla/LootTableExtreme/*_TBC.lua || true
          rm -f package/vanilla/LootTableExtreme/*_TBC.toc || true
          rm -f package/vanilla/LootTableExtreme/LootTableExtreme_TBC.toc || true

          # For TBC package: remove Vanilla-specific files
          rm -f package/tbc/LootTableExtreme/*_Vanilla.lua || true
          rm -f package/tbc/LootTableExtreme/*_Vanilla.toc || true
          rm -f package/tbc/LootTableExtreme/LootTableExtreme.toc || true

          # Zip the packages so each archive has LootTableExtreme/ at the root
          cd package
          # Create vanilla zip: change into the LootTableExtreme dir so the archive root is LootTableExtreme/
          # From package/vanilla the parent (..) is package/, so use ../../ to write to the repo root
          (cd vanilla && zip -r "../../$VANILLA_FILE" LootTableExtreme/) >/dev/null
          # Create tbc zip: same approach
          (cd tbc && zip -r "../../$TBC_FILE" LootTableExtreme/) >/dev/null
          cd ..

          echo "Created packages: $VANILLA_FILE and $TBC_FILE"
          ls -lh "$VANILLA_FILE" "$TBC_FILE"
      
      - name: Generate changelog
        id: changelog
        run: |
          # Get the last release tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LAST_TAG" ]; then
            echo "No previous release found, showing all commits"
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --reverse)
          else
            echo "Generating changelog since $LAST_TAG"
            CHANGELOG=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --reverse)
          fi
          
          # Save changelog to file to handle multiline output
          echo "$CHANGELOG" > changelog.txt
          echo "Generated changelog with $(wc -l < changelog.txt) commits"
      
      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add LootTableExtreme.toc LootTableExtreme_TBC.toc Core.lua || true
          git commit -m "chore: bump version to ${{ steps.version.outputs.new_version }}" || echo "No changes to commit"
          git push
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.package.outputs.version }}
          name: LootTableExtreme v${{ steps.package.outputs.version }} (Vanilla & TBC)
          body: |
            ## LootTableExtreme v${{ steps.package.outputs.version }}

            **WoW Classic (Vanilla) and TBC Release**

            ### Installation (Vanilla)
            1. Download `${{ steps.package.outputs.vanilla_filename }}`
            2. Extract the zip file
            3. Move the `LootTableExtreme` folder to your `World of Warcraft\_classic_era_\Interface\AddOns\` directory

            ### Installation (TBC)
            1. Download `${{ steps.package.outputs.tbc_filename }}`
            2. Extract the zip file
            3. Move the `LootTableExtreme` folder to your `World of Warcraft\_classic_\Interface\AddOns\` directory

            ### Version Info
            - Base Version: ${{ steps.version.outputs.new_version }}
            - Build Number: ${{ steps.build.outputs.number }}
            - Full Version: ${{ steps.package.outputs.version }}

            ### Changes
            ${{ steps.changelog.outputs.changes }}
          body_path: changelog.txt
          files: |
            ${{ steps.package.outputs.vanilla_filename }}
            ${{ steps.package.outputs.tbc_filename }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
